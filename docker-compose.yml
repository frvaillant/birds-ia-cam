services:
  nginx-rtmp:
    build: .
    ports:
      - "1935:1935"
      - "8080:8080"
      - "8765:8765"
    volumes:
      - ./hls:/tmp/hls

  bird-detector:
    build:
      context: .
      dockerfile: Dockerfile.bird-detector
    container_name: bird-detector
    restart: unless-stopped
    depends_on:
      - nginx-rtmp
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    network_mode: "service:nginx-rtmp"

  ffmpeg:
    image: linuxserver/ffmpeg:latest
    container_name: ffmpeg-rtsp-relay
    restart: unless-stopped
    depends_on:
      - nginx-rtmp
    command:
      - -fflags
      - nobuffer+fastseek+flush_packets
      - -flags
      - low_delay
      - -rtsp_transport
      - tcp
      - -i
      - rtsp://${RTSP_USERNAME}:${RTSP_PASSWORD}@${RTSP_HOST}:${RTSP_PORT}/${RTSP_PATH}
      - -vf
      - setpts=PTS-STARTPTS
      - -af
      - asetpts=PTS-STARTPTS
      - -c:v
      - libx264
      - -preset
      - ultrafast
      - -tune
      - zerolatency
      - -profile:v
      - baseline
      - -g
      - "30"
      - -sc_threshold
      - "0"
      - -c:a
      - aac
      - -ar
      - "44100"
      - -b:a
      - "128k"
      - -f
      - flv
      - -flvflags
      - no_duration_filesize
      - rtmp://nginx-rtmp:1935/live/camera
    network_mode: "service:nginx-rtmp"
